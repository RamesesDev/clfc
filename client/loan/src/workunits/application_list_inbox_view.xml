<workunit>
    <invokers>
        <invoker type="home:menu" caption="Loan Inbox" action="init" icon="images/inbox32.png" tooltip="Loan inbox application(s) coming from server"
                 permission="application.viewList" index="3" target="window"/>
        
        <invoker folderid="menu/services/loan" caption="Loan Inbox" permission="application.viewList" index="3"/>  
        
        <invoker type="refreshAction" icon="images/refresh16.png" tooltip="Refresh" action="refreshList"/>
        
         <!--Application Form Actions -->
        <invoker type="formActions" caption="Close" action="_exit" icon="images/cancel16.png" mnemonic="c" visibleWhen="#{mode == 'read'}"/>
        <invoker type="formActions" caption="Open"  action="open" icon="images/open16.png"    mnemonic="o" visibleWhen="#{mode == 'read'}"/>
        <invoker type="formActions" caption="Back"  icon="images/back16.png" mnemonic="b" action="back" visibleWhen="#{view!='main'}"/>
         
        <!-- Allowed State Codes/ Resend Application(s) -->
        <!--
        <invoker type="application:state-list" caption="Send Back"        name="FOR_FLA"          permission="application.viewForFLAList"/>
        <invoker type="application:state-list" caption="Approved"         name="APPROVED"         permission="application.viewApprovedList"/>
        <invoker type="application:state-list" caption="Disapproved"      name="DISAPPROVED"      permission="application.viewDisapprovedList"/>
        <invoker type="application:state-list" caption="Disqualified-Out" name="DISQUALIFIED_OUT" permission="application.viewDisqualifiedOutList"/>
        <invoker type="application:state-list" caption="Canceled-Out"     name="CANCELED_OUT"     permission="application.viewCanceledOutList"/>
        <invoker type="application:state-list" caption="Back-Out"         name="BACK_OUT"         permission="application.viewBackOutList"/>
        -->
    </invokers>    
    <code>
        <![CDATA[
        import com.rameses.rcp.annotations.*;
        import com.rameses.rcp.common.*;
        import com.rameses.util.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.reports.*;
        import com.rameses.common.*;
        
        class LoanApplicationViewInboxListController{
            @Binding
            def binding;
            
            @Service( "LoanApplicationSearchService" )
            def searchSvc;
            
            @Service( "LoanApplicationService" )
            def svc;
            
            def entity=[:];
            def selected;
            def selection;
            def searchText;
            def opener;
            def mode;
            boolean busy;
            
            def itemStatus = InvokerUtil.lookup("application:state-list");
            def loadedStatusList = [];
            
            void init(){
                openLoanOpener();
                
                loadedStatusList.clear();
                if( itemStatus ) {
                    selection = itemStatus[0].properties.name;
                    itemStatus.each { loadedStatusList << it.properties.name }
                }
            }
            
            def listHandler = [
                getColumns: {
                    return [
                        new Column(name:"appno",           caption:"Application no.",width:70),
                        new Column(name:"fullborrowername",caption:"Borrower name",  width:300),
                        new Column(name:"state",           caption:"State",          width:90),
                        new Column(name:"routecode",       caption:"Route",          width:40)
                    ]
                },
                fetchList:{o->
                   o.state = selection;
                   o.allowedStates = loadedStatusList;
                   o.searchText = searchText;
                   return searchSvc.getList(o);
                },
                getRows:{
                    return 29;
                }
           ]as PageListModel;
           
            void setSelection(e){
                this.selection = e;
                searchText = '';
                listHandler.load();
            }
            
            void setSelected(e){
                this.selected=e;
                openLoanOpener();
            }
            
            def view = 'main';
            def back() {
                //loadLedgerInfo();
                return (view = 'main');
            }
            
            def open(){
                //return "page2";
                
                return InvokerUtil.lookupOpener("application:inboxView", [:]);
                
                //openLoanOpener();
            }
            
            void openLoanOpener(){
                initEntity();
                if( !selected ) {
                    mode='read';
                }
                else{
                    entity=svc.read(selected);
                    mode='selected';
                }
                opener=InvokerUtil.lookupOpener("loan:info",[
                    entity:entity,
                    mode:mode,
                    selectHandler:{o->
                        listHandler.load();
                    }
                ]);
            }
            
            void refreshList(){
                listHandler.load();
            }

            void initEntity(){
               entity=[
                    loaninfo:[interestrate:20],
                    propertylist:[],
                    vehiclelist:[],
                    appliancelist:[],
                    comments:[]
                ];
            }
        }
        ]]>
    </code>
    <pages>
        <page name="main"  template="loan.ui.ApplicationLoanInboxView"/>
        <!--<page name="page2" template="loan.ui.AppInfoPage"/>-->
    </pages>
</workunit>