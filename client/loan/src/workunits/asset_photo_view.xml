<workunit>
    <invokers>
        <invoker type="loan:asset_photo_view" target="popup" caption="Image Preview" 
                 action="init" modal="false"/>
    </invokers>
    <code>
        <![CDATA[
        import com.rameses.rcp.annotations.*;
        import com.rameses.rcp.common.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.util.*;
        import loan.ui.asset.util.*;
        
        
        class AssetPhotoViewController {
            
            @Binding
            def binding;
            
            @FormId
            def id;
            
            @FormTitle
            def title;
            
            @Service('LoanAttachmentsService')
            def svc;
            
            def appid;
            def photo;
            def photoView;
            
            def task;
            
                        
            def init() {
                id = photo.objid;
                title = 'Image Preview - ' + photo.name;
                
                photoView = photo.file? photo.file : AssetUtil.getFile( appid, id );
                if( photoView )
                    return 'preview';
                
                task = new DownloadTask(parent: this, loading: true );
                OsirisContext.clientContext.taskManager.addTask( task );
                
                return 'loading';
            }
            
            def onDone = {
                photoView = AssetUtil.getFile( appid, id );
                binding.fireNavigation('preview');
            };
                                    
            @Close
            boolean onClose() {
                if( task && task.loading ) {
                    task.cancelTask();
                }
                return true;
            }
                        
        }
        
        class DownloadTask extends ScheduledTask {
        
            def parent;
            boolean loading;
            
            def param = [:];
        
            long getInterval() { return 10; }
            
            void execute() {
                if( !loading ) {
                    cancelTask();
                    return;
                }
            
                param.appid = parent.appid;
                param.objid = parent.photo.objid;
                def result = parent.svc.readByBlock( param );
                if( result ) {
                    AssetUtil.appendData( parent.appid, parent.photo.objid, result.remove('content') );
                    param.putAll( result );
                    
                    if( result.last ) {
                        loading = false;
                        parent.onDone();
                    }
                }
                else {
                    loading = false;
                    parent.onDone();
                }
            }
            
            void cancelTask() {
                AssetUtil.removeImage( parent.appid, parent.id );
                loading = false;
            }
            
            boolean isEnded() {
                return !loading;
            }
        }        
        ]]>
    </code>
    <pages>
        <page name="loading" template="loan.ui.asset.PhotoPreviewInit"/>
        <page name="preview" template="loan.ui.asset.PhotoPreviewImage"/>
    </pages>
</workunit>