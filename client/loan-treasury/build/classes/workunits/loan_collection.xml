<workunit>
    <invokers>
        <invoker type="cashreceipt:type" caption="Loan Payment" action="create" permission="payment.create"/>
        
        <invoker type="formActions" action="create" icon="images/new16.png"    tooltip="Add New" mnemonic="a" caption="New"    visibleWhen="#{mode=='read'}"/>
        <invoker type="formActions" action="print"  icon="images/print16.png"  tooltip="Print"   mnemonic="p" caption="Print"  visibleWhen="#{mode=='read'}"/>
        <invoker type="formActions" action="save"   icon="images/save16.png"   tooltip="Save"    mnemonic="s" caption="Save"   visibleWhen="#{mode!='read'}"/>
        <invoker type="formActions" action="cancel" icon="images/cancel16.png" tooltip="Cancel"  mnemonic="c" caption="Cancel" visibleWhen="#{mode!='read'}" immediate="true"/>
    </invokers>
    <code>
        <![CDATA[
        import com.rameses.rcp.annotations.*;
        import com.rameses.rcp.common.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.reports.*;
        import com.rameses.util.*;
  
        class loan_collectionController{
            @Service('LoanApplicationService')
            def loanSvc;
            
            @Service('LoanPaymentService')
            def loanpaymentSvc;
            
            @Binding
            def binding;

            def entity;
            def opener;
            def borrower;
            def mode="create";
            def temp;
            
            void create(){
                mode="create";
                entity=[:];
                entity.amountDue=0.00;
                entity.amountTendered=0.00;
                entity.amount=0.00;
                entity.change=0.00;
                binding?.focus("entity.borrowername");
            }
            
            def lookup(){
                return InvokerUtil.lookupOpener("loan_app:lookup",[searchText:entity.borrowername,selectHandler:sHandler]);
            }           
            
            def sHandler = {o->
                entity.appid=o.objid;
                entity.appno=o.appno;
                entity.borrower=o.borrower;
                entity.amountDue=o.amountDue;
                entity.borrowername=o.borrowername;
                binding.refresh();
            };

            def paymentOptions=InvokerUtil.lookupActions("payment:option",{
                return [unpaid:entity.amount, actionHandler:payHandler]
            } as InvokerParameter)
            
            def payHandler={o->
                entity.amountTendered=o.amount + o.change;
                entity.change=o.change? o.change : 0.00;
                binding.refresh();
            };
            
            void save(){
                loanpaymentSvc.post(entity);
                MsgBox.alert("Payment has been saved.");
                mode="read";
            }
            
            def cancel(){
                create();
                return "_close";
            }
            
            def print(){
            
            }
            
            /*
            def print(){
                report.viewReport();
                return "page2";
            }
            def report=[
                getReportName:{
                    return "loantreasury.collection.ui.LoanCollectionReport.jasper";
                },
                getReportData:{
                    //return ;
                }
            ] as ReportModel;
            */
        }
      ]]> 
    </code>
    <pages>
	<page template="loantreasury.collection.ui.LoanCollection"/>
        <page name="page2" template="loantreasury.collection.ui.CollectionRemitReport"/>
    </pages>    
</workunit>