<workunit>
    
    <invokers>
        <invoker folderid="menu/services/loan" caption="Field Collection Remittance" action="init"
                 permission="field_collection_remittance.create"/>
        
        <invoker type="home:menu" caption="Field Collection Remittance" action="init" permission="field_collection_remittance.create"
                 target="window" icon="images/indent32.png"/>
        
        <invoker type="formActions" mnemonic="n" action="open" caption="Next"
            tooltip="Next" icon="images/next16.png" visibleWhen="#{mode=='init'}" default="true"/>
            
        <invoker type="formActions" mnemonic="s" action="save" caption="Save"
            tooltip="Save Remittance" icon="images/save16.png" visibleWhen="#{mode=='create'}" />
            
        <invoker type="formActions" mnemonic="c" action="cancel" caption="Cancel" icon="images/cancel16.png" 
            tooltip="Cancel" visibleWhen="#{mode=='create'}"/>
            
        <invoker type="formActions" mnemonic="f" action="findPayee" caption="Find" 
            tooltip="Find/Search Payee" icon="images/search16.png" immediate="true" visibleWhen="#{mode=='create'}"/>
            
        <invoker type="formActions" mnemonic="c" action="cancel" caption="Close" 
            tooltip="Close" icon="images/cancel16.png" visibleWhen="#{mode=='read'}"/>
    </invokers>
    <code>
        <![CDATA[
        import com.rameses.rcp.annotations.*;
        import com.rameses.rcp.common.*;
        import com.rameses.osiris2.client.*;
        import com.rameses.osiris2.reports.*;
        import com.rameses.common.*;
        
        class LoanRemittanceController{
            @Service("LoanRemittanceService")
            def svc;
            
            @Service("LoanCollectionSheetService")
            def colSheetSvc;

            @Binding
            def binding;
            
            def entity=[:];
            def filter = [:];
            
            def mode;
            
            def selected;
            def prevRAmount;
            
            def breakDownOpener;
            
            void init(){
                mode = 'init';
            }
            
            def open() {
                entity = colSheetSvc.findByCode( filter );
                entity.total=0.00;
                entity.list.each{
                    if( !it.amountpaid ) it.amountpaid = 0.00;
                    entity.total += it.amountpaid;
                };
                breakDownOpener = InvokerUtil.lookupOpener('cashreceipt:breakdown',[totalAmount:entity.total]);
                listHandler.load();
                mode="create";
                return "form";
            }
            
            def cancel(){
                entity = null;
                mode='init';
                return "_default";
            }
        
            def listHandler = [
                getRows:{return 21;},
                getColumns:{
                    return[ 
                            new Column(name:"billno",       caption:"Bill No.",  width:90),
                            new Column(name:"name",         caption:"Name",      width:295),
                            new Column(name:"totalDaysDue", caption:"Days Due",  width:80),
                            new Column(name:"totalDue",     caption:"Total Due", width:85),
                            new Column(name:"dailyPayment", caption:"Daily Pyt", width:90),
                            new Column(name:"amountpaid",   caption:"Amount Paid", editable:true, type:"decimal", width: 100),
                          ]
                },
                fetchList:{o-> 
                    return entity.list;
                },
                onUpdateItem:{o->
                    if(!o?.amountpaid)
                        o?.amountpaid = 0.00;
                    if(o?.amountpaid || o?.amountpaid == 0.00){
                        entity.total += o?.amountpaid - prevRAmount;
                    }
                    breakDownOpener.handle.totalAmount = entity.total;
                }
            ]as PageListModel;

            void setSelected( e ){
                selected = e;
                def pos = entity.list.indexOf( selected )
                if(pos!=-1) prevRAmount = entity.list.amountpaid[pos];
            }
    
            def shortSelectHandler;
            def shortHandler={o->
                entity.routecode=o.code;
                entity.collector=o.collector;
                entity.routedescription=o.description;
                entity.amount = difference;
                binding.refresh("entity.route");
            };
            
            def overSelectHandler;
            def overHandler={o->
                entity.routecode=o.code;
                entity.collector=o.collector;
                entity.routedescription=o.description;
                entity.amount = difference;
                binding.refresh("entity.route");
            };
            
            def difference;
            def save(){
                def brkHandle = breakDownOpener.handle;
                if(brkHandle.totalBreakdown != entity.total){
                    //Getting the differences of total amount paid and cash breakdown
                    difference = brkHandle.totalBreakdown - entity.total;
                    entity.amount = difference;
                    
                    //For Short Payment/Remittance
                    if(brkHandle.totalBreakdown < entity.total){
                        MsgBox.alert("Total Amount " +entity.total+ " and Total Cash Breakdown " +brkHandle.totalBreakdown+ 
                        " is not equal.\nwith a Total Difference of " +difference+ ".");                    
                        return InvokerUtil.lookupOpener("collection:shortagePayment",[
                            entity:entity, shortHandler:shortSelectHandler
                            ]);
                            
                        mode = "print";
                        //print();
                    }    
                    
                    //For Over Payment/Remittance
                    if(brkHandle.totalBreakdown > entity.total){
                        MsgBox.alert("Total Amount " +entity.total+ " and Total Cash Breakdown " +brkHandle.totalBreakdown+ 
                            " is not equal.\nwith an overpayment of " +difference+ ".");
                        return InvokerUtil.lookupOpener("collection:overPayment",[ 
                            entity:entity, overHandler:overSelectHandler, mode:mode
                            ]);
                            
                        mode = "print";
                        //print();
                    }
                }    
                if( entity.total <= 0 ){
                    if(!MsgBox.confirm('Are you sure you want to remit this collection sheet with 0(zero) amount?')) return;
                }
                else{
                    if(!MsgBox.confirm('You are about to remit this collection sheet.\nPlease verify that all items correct. Proceed?')) return;
                }
            
                entity.breakdown = brkHandle.list;
                svc.remitCollectionSheet( entity );
                mode = "read";
            }

            def print(){
                //MsgBox.alert("Printing is not supported at this time.");
                report();
            }
            def collectionSheet;
            def report = [   
                getReportName:{ return 'loantreasury/printout/OveragePayment.jasper'; },
                getReportData:{ //return collectionSheet.list;
                        def data = [entity:entity];
                        
                        data.collector = data.collector;
                        data.date = data.date;
                        
                        if( data.routecode ==null )
                            data.routecode = '';
                        else data.routecode = data.routecode;
                        if( data.routedescription ==null )
                            data.routedescription = '';
                        else data.routedescription = data.routedescription;
                        data.route = data.routecode + " - " + data.routedescription;
                        
                        if(data.amount!=null)    
                            data.amount = new BigDecimal(data.amount);
                        else
                            data.amount = new BigDecimal(0.00);
                            
                        data.reasons = data.reasons;
                        data.srno = data.srno;
                        data.orno = data.orno;
                        
                        return data;
                },
                getParameters:{
                    return [
                            BRANCH_NAME: OsirisContext.env.CLIENT.name ,
                            PRINTDATE: new Date(), 
                            User: OsirisContext.env.USERINFO.firstname + ' ' + OsirisContext.env.USERINFO.lastname
                            ]
                }
            ] as ReportModel;
    
            def routeSelectHandler={o->
                entity.routecode=o.code;
                entity.routedescription=o.description;
                binding.refresh("entity.routecode");
            };
            
            def lookupRoute() {
                return InvokerUtil.lookupOpener("loan:routeLookup",[selectHandler:routeSelectHandler]);
            }
            
            def searchText;
            def selectHandler;
            def searchPayee;
            
            def payeeHandler={o->
                entity.searchText
            };
            
            def findPayee(){
                return InvokerUtil.lookupOpener("collection:findPayee",[:]);
                                   //[selectHandler:payeeHandler]);                    
                                  //[searchText:entity.borrowername,selectHandler:payeeHandler]);                    
            }
            
            /*
            def capturePayment() {
                return InvokerUtil.lookupOpener('application:capturePayment',[
                    appid: entity.objid,
                    handler: {
                        loadLedgerInfo();
                        listHandler.refresh();
                    }
                ]);
            }
            */
        }
        ]]>
    </code>
    <pages>
        <page template="loantreasury.remittance.field.LoanRemittanceInitPage"/>
        <page name="form" template="loantreasury.remittance.field.LoanRemittancePage"/>
        <page name="print" template="loantreasury.collectionsheet.CollectionSheetPrintPage"/>
    </pages>
</workunit>